<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PlusMoney - Reportes de Préstamos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <style>
    :root {
      --primary-color: #1abc9c;
      --primary-dark: #16a085;
      --secondary-color: #2a2a3f;
      --background-color: #2c3e50;
      --text-color: #ffffff;
      --card-bg: #34495e;
      --danger-color: #e74c3c;
      --success-color: #2ecc71;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
    }

    body {
      background-color: var(--background-color);
      color: var(--text-color);
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: var(--primary-color);
      margin-bottom: 20px;
      text-align: center;
    }

    .filters {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    label {
      font-weight: 500;
    }

    select, button {
      padding: 8px 15px;
      border-radius: 5px;
      border: 1px solid var(--primary-color);
      background-color: var(--secondary-color);
      color: var(--text-color);
      cursor: pointer;
    }

    button {
      background-color: var(--primary-color);
      border: none;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: var(--primary-dark);
    }

    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background-color: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .stat-card h3 {
      color: var(--primary-color);
      margin-bottom: 10px;
      font-size: 1.1rem;
    }

    .stat-card p {
      font-size: 1.8rem;
      font-weight: 700;
    }

    .charts-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 30px;
    }

    .chart-card {
      background-color: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .chart-card h2 {
      color: var(--primary-color);
      margin-bottom: 15px;
      text-align: center;
    }

    .chart-container {
      width: 100%;
      height: 300px;
    }

    .loading {
      display: none;
      text-align: center;
      margin: 20px 0;
      color: var(--primary-color);
    }

    @media (max-width: 768px) {
      .charts-container {
        grid-template-columns: 1fr;
      }
      
      .filters {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Reportes de Préstamos</h1>
    
    <div class="filters">
      <div class="filter-group">
        <label for="year">Año:</label>
        <select id="year">
          <!-- Se llenará dinámicamente -->
        </select>
      </div>
      
      <div class="filter-group">
        <label for="month">Mes:</label>
        <select id="month">
          <!-- Se llenará dinámicamente -->
        </select>
      </div>
      
      <button id="generateReport">Generar Reporte</button>
    </div>
    
    <div id="loading" class="loading">
      <p>Cargando datos...</p>
    </div>
    
    <div class="stats-container">
      <div class="stat-card">
        <h3>Total de Préstamos</h3>
        <p id="totalLoans">0</p>
      </div>
      
      <div class="stat-card">
        <h3>Total de Capital</h3>
        <p id="totalCapital">$0.00</p>
      </div>
      
      <div class="stat-card">
        <h3>Total de Moras</h3>
        <p id="totalLateFees">$0.00</p>
      </div>
      
      <div class="stat-card">
        <h3>Total de Intereses</h3>
        <p id="totalInterest">$0.00</p>
      </div>
      
      <div class="stat-card">
        <h3>Capital Pagado</h3>
        <p id="paidCapital">$0.00</p>
      </div>
      
      <div class="stat-card">
        <h3>Intereses Pagados</h3>
        <p id="paidInterest">$0.00</p>
      </div>
      
      <div class="stat-card">
        <h3>Total Pagado</h3>
        <p id="totalPaid">$0.00</p>
      </div>
      
      <div class="stat-card">
        <h3>Clientes Activos</h3>
        <p id="activeClients">0</p>
      </div>
      
      <div class="stat-card">
        <h3>Préstamos Activos</h3>
        <p id="activeLoans">0</p>
      </div>
    </div>
    
    <div class="charts-container">
      <div class="chart-card">
        <h2>Distribución de Pagos</h2>
        <div class="chart-container">
          <canvas id="pieChart"></canvas>
        </div>
      </div>
      
      <div class="chart-card">
        <h2>Desempeño de Préstamos</h2>
        <div class="chart-container">
          <canvas id="barChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuración de Firebase (usa tu configuración)
    const firebaseConfig = {
      apiKey: "AIzaSyDLi-egzQlgbKW8XV_qIhU6313Gd8gocCg",
      authDomain: "inventario-35d6b.firebaseapp.com",
      databaseURL: "https://inventario-35d6b-default-rtdb.firebaseio.com",
      projectId: "inventario-35d6b",
      storageBucket: "inventario-35d6b.appspot.com",
      messagingSenderId: "266100399659",
      appId: "1:266100399659:web:92358d28cbd803c8a7d46e"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Variables globales
    let currentUser = null;
    let pieChart = null;
    let barChart = null;

    document.addEventListener('DOMContentLoaded', function() {
      // Verificar autenticación
      auth.onAuthStateChanged(user => {
        if (user) {
          currentUser = user;
          initApp();
        } else {
          window.location.href = 'index.html';
        }
      });
    });

    function initApp() {
      // Inicializar selectores de año y mes
      initDateSelectors();
      
      // Cargar reporte del mes actual por defecto
      loadCurrentMonthReport();
      
      // Configurar evento para el botón de generar reporte
      document.getElementById('generateReport').addEventListener('click', generateReport);
    }

    function initDateSelectors() {
      const yearSelect = document.getElementById('year');
      const monthSelect = document.getElementById('month');
      
      // Años (últimos 5 años y el actual)
      const currentYear = new Date().getFullYear();
      for (let i = currentYear; i >= currentYear - 5; i--) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        if (i === currentYear) option.selected = true;
        yearSelect.appendChild(option);
      }
      
      // Meses
      const months = [
        'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
      ];
      
      months.forEach((month, index) => {
        const option = document.createElement('option');
        option.value = index + 1;
        option.textContent = month;
        if (index === new Date().getMonth()) option.selected = true;
        monthSelect.appendChild(option);
      });
    }

    function loadCurrentMonthReport() {
      const currentDate = new Date();
      const currentMonth = currentDate.getMonth() + 1;
      const currentYear = currentDate.getFullYear();
      
      // Cargar reporte para el mes actual
      loadReportData(currentMonth, currentYear);
    }

    function generateReport() {
      const selectedMonth = parseInt(document.getElementById('month').value);
      const selectedYear = parseInt(document.getElementById('year').value);
      
      // Cargar reporte para el mes y año seleccionados
      loadReportData(selectedMonth, selectedYear);
    }

    async function loadReportData(month, year) {
      showLoading(true);
      
      try {
        // Obtener todos los préstamos del usuario actual
        let loansQuery = db.collection("Loans").where("userId", "==", currentUser.uid);
        const loansSnapshot = await loansQuery.get();
        
        if (loansSnapshot.empty) {
          updateStatsWithZero();
          showLoading(false);
          return;
        }
        
        // Filtrar préstamos por mes y año
        const startDate = new Date(year, month - 1, 1);
        const endDate = new Date(year, month, 0, 23, 59, 59);
        
        const reportData = {
          totalLoans: 0,
          totalCapital: 0,
          totalLateFees: 0,
          totalInterest: 0,
          paidCapital: 0,
          paidInterest: 0,
          totalPaid: 0,
          activeClients: new Set(),
          activeLoans: 0,
          pieChartData: {
            labels: ['Capital Pagado', 'Interés Pagado', 'Mora Cobrada', 'Pendiente'],
            data: [0, 0, 0, 0],
            colors: ['#1abc9c', '#3498db', '#e74c3c', '#f39c12']
          },
          barChartData: {
            labels: ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4'],
            capitalData: [0, 0, 0, 0],
            interestData: [0, 0, 0, 0],
            lateFeeData: [0, 0, 0, 0]
          }
        };
        
        // Procesar cada préstamo
        loansSnapshot.forEach(doc => {
          const loan = doc.data();
          const loanDate = loan.createdAt ? loan.createdAt.toDate() : new Date();
          
          // Verificar si el préstamo fue creado en el mes seleccionado
          if (loanDate >= startDate && loanDate <= endDate) {
            reportData.totalLoans++;
            reportData.totalCapital += loan.amount || 0;
            reportData.totalInterest += loan.totalInterest || 0;
            
            // Contar clientes únicos
            if (loan.client && loan.client.id) {
              reportData.activeClients.add(loan.client.id);
            }
            
            // Verificar préstamos activos
            if (loan.status === 'active' || loan.status === 'overdue') {
              reportData.activeLoans++;
            }
          }
          
          // Procesar pagos del préstamo (si están en el mes seleccionado)
          if (loan.payments) {
            loan.payments.forEach(payment => {
              const paymentDate = payment.date ? payment.date.toDate() : new Date();
              
              if (paymentDate >= startDate && paymentDate <= endDate) {
                // Calcular capital e interés pagado
                if (payment.type === 'full' || payment.type === 'capital' || payment.type === 'custom') {
                  const capitalPaid = payment.amount - (payment.lateFee || 0);
                  reportData.paidCapital += capitalPaid;
                  reportData.totalPaid += capitalPaid;
                }
                
                if (payment.type === 'full' || payment.type === 'interest' || payment.type === 'custom') {
                  const interestPaid = payment.amount - (payment.lateFee || 0);
                  reportData.paidInterest += interestPaid;
                  reportData.totalPaid += interestPaid;
                }
                
                // Sumar moras
                if (payment.lateFee) {
                  reportData.totalLateFees += payment.lateFee;
                  reportData.totalPaid += payment.lateFee;
                }
                
                // Actualizar gráfico de barras por semana
                const weekOfMonth = Math.floor((paymentDate.getDate() - 1) / 7);
                if (weekOfMonth >= 0 && weekOfMonth < 4) {
                  if (payment.type === 'full' || payment.type === 'capital' || payment.type === 'custom') {
                    reportData.barChartData.capitalData[weekOfMonth] += payment.amount - (payment.lateFee || 0);
                  }
                  if (payment.type === 'full' || payment.type === 'interest' || payment.type === 'custom') {
                    reportData.barChartData.interestData[weekOfMonth] += payment.amount - (payment.lateFee || 0);
                  }
                  if (payment.lateFee) {
                    reportData.barChartData.lateFeeData[weekOfMonth] += payment.lateFee;
                  }
                }
              }
            });
          }
        });
        
        // Calcular pendientes para el gráfico circular
        reportData.pieChartData.data[0] = reportData.paidCapital;
        reportData.pieChartData.data[1] = reportData.paidInterest;
        reportData.pieChartData.data[2] = reportData.totalLateFees;
        reportData.pieChartData.data[3] = reportData.totalCapital - reportData.paidCapital;
        
        // Actualizar número de clientes activos
        reportData.activeClients = reportData.activeClients.size;
        
        // Actualizar la interfaz con los datos
        updateStats(reportData);
        updateCharts(reportData);
        
      } catch (error) {
        console.error("Error al cargar reporte:", error);
        alert("Error al cargar los datos del reporte");
      } finally {
        showLoading(false);
      }
    }

    function updateStatsWithZero() {
      const zeroData = {
        totalLoans: 0,
        totalCapital: 0,
        totalLateFees: 0,
        totalInterest: 0,
        paidCapital: 0,
        paidInterest: 0,
        totalPaid: 0,
        activeClients: 0,
        activeLoans: 0
      };
      updateStats(zeroData);
      
      // Actualizar gráficos con datos cero
      updateCharts({
        pieChartData: {
          labels: ['Capital Pagado', 'Interés Pagado', 'Mora Cobrada', 'Pendiente'],
          data: [0, 0, 0, 0],
          colors: ['#1abc9c', '#3498db', '#e74c3c', '#f39c12']
        },
        barChartData: {
          labels: ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4'],
          capitalData: [0, 0, 0, 0],
          interestData: [0, 0, 0, 0],
          lateFeeData: [0, 0, 0, 0]
        }
      });
    }

    function updateStats(data) {
      document.getElementById('totalLoans').textContent = data.totalLoans;
      document.getElementById('totalCapital').textContent = `$${formatCurrency(data.totalCapital)}`;
      document.getElementById('totalLateFees').textContent = `$${formatCurrency(data.totalLateFees)}`;
      document.getElementById('totalInterest').textContent = `$${formatCurrency(data.totalInterest)}`;
      document.getElementById('paidCapital').textContent = `$${formatCurrency(data.paidCapital)}`;
      document.getElementById('paidInterest').textContent = `$${formatCurrency(data.paidInterest)}`;
      document.getElementById('totalPaid').textContent = `$${formatCurrency(data.totalPaid)}`;
      document.getElementById('activeClients').textContent = data.activeClients;
      document.getElementById('activeLoans').textContent = data.activeLoans;
    }

    function updateCharts(data) {
      // Destruir gráficos existentes si hay alguno
      if (pieChart) pieChart.destroy();
      if (barChart) barChart.destroy();
      
      // Gráfico de pastel (distribución de pagos)
      const pieCtx = document.getElementById('pieChart').getContext('2d');
      pieChart = new Chart(pieCtx, {
        type: 'pie',
        data: {
          labels: data.pieChartData.labels,
          datasets: [{
            data: data.pieChartData.data,
            backgroundColor: data.pieChartData.colors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: '#ffffff'
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: $${formatCurrency(value)} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
      
      // Gráfico de barras (desempeño de préstamos)
      const barCtx = document.getElementById('barChart').getContext('2d');
      barChart = new Chart(barCtx, {
        type: 'bar',
        data: {
          labels: data.barChartData.labels,
          datasets: [
            {
              label: 'Capital',
              data: data.barChartData.capitalData,
              backgroundColor: 'rgba(26, 188, 156, 0.7)',
              borderColor: 'rgba(26, 188, 156, 1)',
              borderWidth: 1
            },
            {
              label: 'Interés',
              data: data.barChartData.interestData,
              backgroundColor: 'rgba(52, 152, 219, 0.7)',
              borderColor: 'rgba(52, 152, 219, 1)',
              borderWidth: 1
            },
            {
              label: 'Mora',
              data: data.barChartData.lateFeeData,
              backgroundColor: 'rgba(231, 76, 60, 0.7)',
              borderColor: 'rgba(231, 76, 60, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              stacked: true,
              ticks: {
                color: '#ffffff',
                callback: function(value) {
                  return '$' + formatCurrency(value);
                }
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            },
            y: {
              stacked: true,
              ticks: {
                color: '#ffffff'
              },
              grid: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: '#ffffff'
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.dataset.label || '';
                  const value = context.raw || 0;
                  return `${label}: $${formatCurrency(value)}`;
                }
              }
            }
          }
        }
      });
    }

    function formatCurrency(value) {
      return parseFloat(value).toLocaleString('es-ES', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }
  </script>
</body>
</html>
