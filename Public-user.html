<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cliente - Sistema de Pr√©stamos</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --primary-color: #1abc9c;
      --primary-dark: #16a085;
      --secondary-color: #2a2a3f;
      --background-color: #2c3e50;
      --text-color: #ffffff;
      --text-light: #a8a8a8;
      --border-color: #444;
      --card-bg: #34495e;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --success-color: #2ecc71;
      --info-color: #3498db;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      margin: 0;
      min-height: 100vh;
    }

    /* Login Section Styles */
    #login-section {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-container {
      width: 100%;
      max-width: 400px;
      background-color: var(--secondary-color);
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .login-logo {
      width: 100px;
      height: auto;
      margin: 0 auto 1.5rem;
      display: block;
    }

    .login-title {
      color: var(--primary-color);
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-light);
      font-weight: 500;
    }

    .form-control {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--background-color);
      color: var(--text-color);
      font-size: 1rem;
    }

    .btn {
      background-color: var(--primary-color);
      color: var(--text-color);
      border: none;
      border-radius: 8px;
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn i {
      margin-right: 8px;
    }

    .btn:hover {
      background-color: var(--primary-dark);
    }

    .btn-block {
      display: block;
      width: 100%;
    }

    .btn-success {
      background-color: var(--success-color);
    }

    .btn-danger {
      background-color: var(--danger-color);
    }

    .btn-info {
      background-color: var(--info-color);
    }

    .alert {
      padding: 0.75rem 1rem;
      border-radius: 8px;
      display: none;
      align-items: center;
      margin-bottom: 1rem;
    }

    .alert i {
      margin-right: 0.5rem;
    }

    .alert-danger {
      background-color: rgba(231, 76, 60, 0.2);
      border: 1px solid var(--danger-color);
      color: var(--danger-color);
    }

    .alert-warning {
      background-color: rgba(243, 156, 18, 0.2);
      border: 1px solid var(--warning-color);
      color: var(--warning-color);
    }

    .alert-success {
      background-color: rgba(46, 204, 113, 0.2);
      border: 1px solid var(--success-color);
      color: var(--success-color);
    }

    .spinner {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      border-radius: 12px;
      z-index: 100;
    }

    .spinner.active {
      display: flex;
    }

    .spinner-icon {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Client Section Styles */
    #client-section {
      display: none;
      min-height: 100vh;
      padding-bottom: 70px;
    }

    .header-client {
      background-color: var(--secondary-color);
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
    }

    .client-profile {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .client-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: var(--background-color);
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 0.5rem;
      font-size: 1.5rem;
    }

    .client-name {
      font-size: 1.2rem;
      margin: 0;
    }

    .client-id {
      font-size: 0.8rem;
      color: var(--text-light);
    }

    .company-info-header {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .company-info-header img {
      margin-bottom: 0.5rem;
    }

    .company-info-header span {
      font-size: 0.9rem;
      text-align: right;
    }

    .main-container-client {
      padding: 1rem;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .card {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .card-title {
      color: var(--primary-color);
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }

    .loan-balance {
      font-size: 2rem;
      font-weight: 700;
      text-align: center;
      margin: 1rem 0;
    }

    .progress-bar {
      height: 10px;
      background-color: var(--background-color);
      border-radius: 5px;
      margin: 1rem 0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background-color: var(--primary-color);
      width: 0%;
      transition: width 0.5s ease;
    }

    .loan-details-btn {
      margin-top: 1rem;
      width: 100%;
    }

    .search-bar {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .search-bar input {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--background-color);
      color: var(--text-color);
    }

    .search-bar select {
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--background-color);
      color: var(--text-color);
    }

    .payment-history {
      max-height: 300px;
      overflow-y: auto;
    }

    .payment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      border-bottom: 1px solid var(--border-color);
    }

    .payment-amount {
      font-weight: 700;
    }

    .payment-date {
      font-size: 0.8rem;
      color: var(--text-light);
    }

    .payment-type {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .payment-type.full {
      background-color: rgba(46, 204, 113, 0.2);
      color: var(--success-color);
    }

    .payment-type.capital {
      background-color: rgba(52, 152, 219, 0.2);
      color: var(--info-color);
    }

    .payment-type.interest {
      background-color: rgba(155, 89, 182, 0.2);
      color: #9b59b6;
    }

    .payment-type.late {
      background-color: rgba(231, 76, 60, 0.2);
      color: var(--danger-color);
    }

    .profile-info {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.75rem;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
    }

    .info-label {
      font-weight: 500;
      color: var(--primary-color);
    }

    .info-value {
      text-align: right;
    }

    .document-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }

    .document-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background-color: var(--background-color);
      border-radius: 8px;
    }

    .document-icon {
      color: var(--primary-color);
      margin-right: 0.5rem;
    }

    .document-name {
      flex: 1;
    }

    .document-action {
      color: var(--primary-color);
      cursor: pointer;
      margin-left: 0.5rem;
    }

    .settings-option {
      margin-bottom: 1rem;
    }

    .settings-option label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-light);
      font-weight: 500;
    }

    .theme-selector {
      display: flex;
      gap: 0.5rem;
    }

    .theme-option {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      background-color: var(--background-color);
      cursor: pointer;
      text-align: center;
      flex: 1;
    }

    .theme-option.selected {
      background-color: var(--primary-color);
      color: white;
    }

    .color-picker {
      width: 100%;
      height: 40px;
      cursor: pointer;
    }

    .settings-toggle {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .settings-toggle input {
      margin-right: 0.5rem;
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: var(--secondary-color);
      display: flex;
      justify-content: space-around;
      padding: 0.5rem 0;
      border-top: 1px solid var(--border-color);
      z-index: 100;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
      color: var(--text-light);
      font-size: 0.8rem;
      padding: 0.5rem;
    }

    .nav-item i {
      font-size: 1.2rem;
      margin-bottom: 0.25rem;
    }

    .nav-item.active {
      color: var(--primary-color);
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background-color: var(--secondary-color);
      padding: 2rem;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-title {
      margin-bottom: 1.5rem;
      color: var(--primary-color);
      text-align: center;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .avatar-selector {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .avatar-option {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
      background-color: var(--background-color);
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.5rem;
    }

    .avatar-option.selected {
      background-color: var(--primary-color);
      color: white;
    }

    .file-upload-btn {
      display: inline-block;
      padding: 1rem;
      background-color: var(--background-color);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      font-size: 1.5rem;
      margin-top: 0.5rem;
    }

    .file-upload-btn input {
      display: none;
    }

    .receipt-preview {
      background-color: white;
      color: black;
      padding: 1rem;
      border-radius: 8px;
      font-family: Arial, sans-serif;
    }

    /* Responsive Styles */
    @media (min-width: 768px) {
      .profile-info {
        grid-template-columns: 1fr 1fr;
      }

      .document-list {
        grid-template-columns: 1fr 1fr;
      }

      .avatar-selector {
        grid-template-columns: repeat(6, 1fr);
      }
    }

    /* Light Theme */
    .light-theme {
      --background-color: #f5f5f5;
      --text-color: #333333;
      --text-light: #666666;
      --border-color: #dddddd;
      --card-bg: #ffffff;
    }

    /* Font Sizes */
    .font-small {
      font-size: 14px;
    }

    .font-medium {
      font-size: 16px;
    }

    .font-large {
      font-size: 18px;
    }
  </style>
</head>
<body>
  <!-- Login Section -->
  <section id="login-section">
    <div class="login-container">
      <div class="spinner" id="loginSpinner">
        <div class="spinner-icon"></div>
      </div>
      <img src="logo.png" alt="Sistema de Pr√©stamos Logo" class="login-logo">
      <h1 class="login-title">Bienvenido</h1>
      <form id="loginForm">
        <div class="form-group">
          <label for="loginUsername">Nombre de Usuario</label>
          <input type="text" id="loginUsername" class="form-control" required aria-label="Nombre de usuario">
        </div>
        <div class="form-group">
          <label for="loginPin">PIN (4 d√≠gitos)</label>
          <input type="password" id="loginPin" class="form-control" minlength="4" maxlength="4" pattern="\d{4}" required aria-label="PIN de 4 d√≠gitos">
        </div>
        <button type="submit" class="btn">
          <i class="fas fa-sign-in-alt"></i> <span data-lang="login">Iniciar Sesi√≥n</span>
        </button>
      </form>
      <div id="loginAlert" class="alert alert-danger" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <span id="loginAlertMessage"></span>
      </div>
    </div>
  </section>

  <!-- Client Section -->
  <section id="client-section">
    <div class="header-client">
      <div class="client-profile">
        <div id="clientAvatar" class="client-avatar"><i class="fas fa-user"></i></div>
        <h2 class="client-name" id="clientName">Nombre del Cliente</h2>
        <span class="client-id" id="clientId">ID: 000-0000000-0</span>
      </div>
      <!-- Mostrar logo y nombre de la empresa -->
      <div class="company-info-header">
        <img id="companyLogoHeader" src="" alt="Logo Empresa" style="display: none; max-height: 40px;">
        <span id="companyNameHeader"></span>
      </div>
    </div>

    <div class="main-container-client">
      <!-- Summary Section -->
      <div id="summary-section" class="section active">
        <div class="card">
          <div id="latePaymentAlert" class="alert alert-danger" style="display: none;">
            <i class="fas fa-exclamation-circle"></i>
            <span id="latePaymentMessage"></span>
          </div>
          <h3 class="card-title" data-lang="loan_balance">Saldo Pendiente</h3>
          <div class="loan-balance" id="loanBalance">$0.00</div>
          <div class="late-payment-message" id="latePaymentText" style="display: none;"></div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
          </div>
          <button class="btn btn-info loan-details-btn" id="detailsBtn">
            <i class="fas fa-info-circle"></i> <span data-lang="view_details">Ver Detalles</span>
          </button>
        </div>
        <div class="card">
          <h3 class="card-title" data-lang="loan_progress">Progreso del Pr√©stamo</h3>
          <div id="loanProgress">
            <p id="progressText" data-lang="loading_progress">Cargando progreso...</p>
          </div>
        </div>
      </div>

      <!-- History Section -->
      <div id="history-section" class="section">
        <div class="card">
          <h3 class="card-title" data-lang="payment_history">Historial de Pagos</h3>
          <div class="search-bar">
            <input type="text" id="historySearch" placeholder="Buscar por fecha (dd/mm/aaaa)" aria-label="Buscar pagos">
            <select id="historyFilter" aria-label="Filtrar por tipo de pago">
              <option value="all" data-lang="all">Todos</option>
              <option value="full" data-lang="full">Completo</option>
              <option value="capital" data-lang="capital">Capital</option>
              <option value="interest" data-lang="interest">Inter√©s</option>
              <option value="late" data-lang="late">Con Mora</option>
            </select>
          </div>
          <div class="payment-history" id="paymentHistory">
            <p data-lang="loading_history">Cargando historial de pagos...</p>
          </div>
        </div>
      </div>

      <!-- Profile Section -->
      <div id="profile-section" class="section">
        <div class="card">
          <h3 class="card-title" data-lang="my_profile">Mi Perfil</h3>
          <div class="profile-info">
            <div class="info-item">
              <span class="info-label" data-lang="full_name">Nombre completo:</span>
              <span class="info-value" id="profileName">-</span>
            </div>
            <div class="info-item">
              <span class="info-label" data-lang="id">Identificaci√≥n:</span>
              <span class="info-value" id="profileId">-</span>
            </div>
            <div class="info-item">
              <span class="info-label" data-lang="phone">Tel√©fono:</span>
              <span class="info-value" id="profilePhone">-</span>
            </div>
            <div class="info-item">
              <span class="info-label" data-lang="address">Direcci√≥n:</span>
              <span class="info-value" id="profileAddress">-</span>
            </div>
            <div class="info-item">
              <span class="info-label" data-lang="nationality">Nacionalidad:</span>
              <span class="info-value" id="profileNationality">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">Empresa donde labora:</span>
              <span class="info-value" id="profileCompany">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">Tiempo en la empresa:</span>
              <span class="info-value" id="profileCompanyTime">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">Fecha de inicio del pr√©stamo:</span>
              <span class="info-value" id="profileLoanStartDate">-</span>
            </div>
          </div>
          <button class="btn btn-info" id="changeAvatarBtn">
            <i class="fas fa-camera"></i> <span data-lang="change_profile_picture">Cambiar Foto de Perfil</span>
          </button>
          <br>
          <br>
          <button class="btn btn-info" id="changePasswordBtn">
            <i class="fas fa-key"></i> <span data-lang="change_password">Cambiar Contrase√±a</span>
          </button>
          <br>
          <br>
          <button class="btn btn-danger" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i> <span data-lang="logout">Cerrar Sesi√≥n</span>
          </button>
        </div>
      </div>

      <!-- Documents Section -->
      <div id="documents-section" class="section">
        <div class="card">
          <h3 class="card-title" data-lang="my_documents">Mis Documentos</h3>
          <div id="documentsAlert" class="alert alert-warning" style="display: none;">
            <i class="fas fa-exclamation-circle"></i>
            <span id="documentsAlertMessage" data-lang="no_documents">No hay documentos disponibles</span>
          </div>
          <div class="document-list" id="documentList"></div>
        </div>
      </div>

      <!-- Settings Section -->
      <div id="settings-section" class="section">
        <div class="card">
          <h3 class="card-title" data-lang="settings">Configuraci√≥n</h3>
          <div class="settings-option">
            <label data-lang="app_theme">Tema de la Aplicaci√≥n</label>
            <div class="theme-selector">
              <div class="theme-option" data-theme="dark" data-lang="dark">Oscuro</div>
              <div class="theme-option" data-theme="light" data-lang="light">Claro</div>
              <div class="theme-option" data-theme="custom" data-lang="custom">Personalizado</div>
            </div>
          </div>
          <div class="settings-option" id="customColorContainer" style="display: none;">
            <label data-lang="custom_color">Color Personalizado</label>
            <input type="color" id="customColorPicker" class="color-picker" value="#15a086">
          </div>
          <div class="settings-option">
            <label data-lang="language">Idioma</label>
            <select id="languageSelector" class="form-control">
              <option value="es" data-lang="spanish">Espa√±ol</option>
              <option value="en" data-lang="english">English</option>
            </select>
          </div>
          <div class="settings-option">
            <label data-lang="notifications">Notificaciones</label>
            <div class="settings-toggle">
              <input type="checkbox" id="emailNotifications">
              <label for="emailNotifications" data-lang="email_notifications">Notificaciones por Email</label>
            </div>
            <div class="settings-toggle">
              <input type="checkbox" id="smsNotifications">
              <label for="smsNotifications" data-lang="sms_notifications">Notificaciones por SMS</label>
            </div>
          </div>
          <div class="settings-option">
            <label data-lang="font_size">Tama√±o de Fuente</label>
            <select id="fontSizeSelector" class="form-control">
              <option value="small" data-lang="small">Peque√±o</option>
              <option value="medium" data-lang="medium">Mediano</option>
              <option value="large" data-lang="large">Grande</option>
            </select>
          </div>
          <div class="settings-option">
            <label data-lang="currency">Formato de Moneda</label>
            <select id="currencySelector" class="form-control">
              <option value="USD" data-lang="usd">USD</option>
              <option value="DOP" data-lang="dop">DOP</option>
            </select>
          </div>
          <button class="btn btn-success" id="saveSettingsBtn">
            <i class="fas fa-save"></i> <span data-lang="save_settings">Guardar Configuraci√≥n</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
      <a class="nav-item active" data-section="summary">
        <i class="fas fa-home"></i>
        <span data-lang="home">Inicio</span>
      </a>
      <a class="nav-item" data-section="history">
        <i class="fas fa-history"></i>
        <span data-lang="history">Historial</span>
      </a>
      <a class="nav-item" data-section="profile">
        <i class="fas fa-user"></i>
        <span data-lang="profile">Perfil</span>
      </a>
      <a class="nav-item" data-section="documents">
        <i class="fas fa-file-alt"></i>
        <span data-lang="documents">Documentos</span>
      </a>
      <a class="nav-item" data-section="settings">
        <i class="fas fa-cog"></i>
        <span data-lang="settings">Ajustes</span>
      </a>
    </div>
  </section>

  <!-- Details Modal -->
  <div class="modal" id="detailsModal">
    <div class="modal-content">
      <h3 class="modal-title" data-lang="loan_details">Detalles del Pr√©stamo</h3>
      <div id="loanDetailsContent"></div>
      <div class="modal-footer">
        <button class="btn btn-info" onclick="closeModal()" data-lang="close">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Avatar Selection Modal -->
  <div class="modal" id="avatarModal">
    <div class="modal-content">
      <h3 class="modal-title" data-lang="select_profile_picture">Seleccionar Foto de Perfil</h3>
      <div class="avatar-selector" id="avatarSelector"></div>
      <div class="form-group">
        <label data-lang="upload_image">Subir Imagen</label>
        <label class="file-upload-btn">
          <i class="fas fa-camera"></i>
          <input type="file" id="profileImageUpload" accept="image/*" aria-label="Subir imagen de perfil">
        </label>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" id="saveAvatarBtn" data-lang="save">Guardar</button>
        <button class="btn btn-danger" onclick="closeModal()" data-lang="cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div class="modal" id="passwordModal">
    <div class="modal-content">
      <h3 class="modal-title" data-lang="change_password">Cambiar Contrase√±a</h3>
      <form id="passwordForm">
        <div class="form-group">
          <label for="currentPin" data-lang="current_pin">PIN Actual</label>
          <input type="password" id="currentPin" class="form-control" minlength="4" maxlength="4" pattern="\d{4}" required aria-label="PIN actual">
        </div>
        <div class="form-group">
          <label for="newPin" data-lang="new_pin">Nuevo PIN</label>
          <input type="password" id="newPin" class="form-control" minlength="4" maxlength="4" pattern="\d{4}" required aria-label="Nuevo PIN">
        </div>
        <div class="form-group">
          <label for="confirmPin" data-lang="confirm_pin">Confirmar Nuevo PIN</label>
          <input type="password" id="confirmPin" class="form-control" minlength="4" maxlength="4" pattern="\d{4}" required aria-label="Confirmar nuevo PIN">
        </div>
        <div id="passwordAlert" class="alert alert-danger" style="display: none;">
          <i class="fas fa-exclamation-circle"></i>
          <span id="passwordAlertMessage"></span>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success" data-lang="save">Guardar</button>
          <button type="button" class="btn btn-danger" onclick="closeModal()" data-lang="cancel">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Document Preview Modal -->
  <div class="modal" id="documentModal">
    <div class="modal-content">
      <h3 class="modal-title" id="documentModalTitle">Vista Previa</h3>
      <div id="documentPreview"></div>
      <div class="modal-footer" id="documentModalFooter">
        <button class="btn btn-info" onclick="closeModal()" data-lang="close">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Info Modal -->
  <div class="modal" id="infoModal">
    <div class="modal-content">
      <h3 class="modal-title" id="infoModalTitle" data-lang="info">Informaci√≥n</h3>
      <p id="infoModalMessage"></p>
      <div class="modal-footer">
        <button class="btn btn-info" onclick="closeModal()" data-lang="accept">Aceptar</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { 
    getFirestore, 
    collection, 
    getDocs, 
    query, 
    where,
    doc,
    getDoc,
    updateDoc,
    setDoc
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDLi-egzQlgbKW8XV_qIhU6313Gd8gocCg",
    authDomain: "inventario-35d6b.firebaseapp.com",
    databaseURL: "https://inventario-35d6b-default-rtdb.firebaseio.com",
    projectId: "inventario-35d6b",
    storageBucket: "inventario-35d6b.appspot.com",
    messagingSenderId: "266100399659",
    appId: "1:266100399659:web:92358d28cbd803c8a7d46e"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);
  const { jsPDF } = window.jspdf;

  // Global Variables
  let currentUser = null;
  let currentLoan = null;
  let paymentReceipts = [];
  let companyInfo = {
    nombreEmpresa: "Empresa de Pr√©stamos",
    rnc: "123-456789-1",
    phone: "809-555-5555",
    address: "Calle Principal #123, Santo Domingo",
    fotoURL: "logo.png"
  };
  let userSettings = {
    theme: 'dark',
    customColor: '#15a086',
    language: 'es',
    emailNotifications: true,
    smsNotifications: false,
    fontSize: 'medium',
    currency: 'USD'
  };
  const isPC = window.innerWidth > 768 && !/Mobi|Android/i.test(navigator.userAgent);

  // Language Translations
  const translations = {
    es: {
      login: 'Iniciar Sesi√≥n',
      view_details: 'Ver Detalles',
      loan_balance: 'Saldo Pendiente',
      loan_progress: 'Progreso del Pr√©stamo',
      loading_progress: 'Cargando progreso...',
      payment_history: 'Historial de Pagos',
      loading_history: 'Cargando historial de pagos...',
      all: 'Todos',
      full: 'Completo',
      capital: 'Capital',
      interest: 'Inter√©s',
      late: 'Con Mora',
      my_profile: 'Mi Perfil',
      full_name: 'Nombre completo',
      id: 'Identificaci√≥n',
      phone: 'Tel√©fono',
      address: 'Direcci√≥n',
      nationality: 'Nacionalidad',
      change_profile_picture: 'Cambiar Foto de Perfil',
      change_password: 'Cambiar Contrase√±a',
      current_pin: 'PIN Actual',
      new_pin: 'Nuevo PIN',
      confirm_pin: 'Confirmar Nuevo PIN',
      logout: 'Cerrar Sesi√≥n',
      my_documents: 'Mis Documentos',
      no_documents: 'No hay documentos disponibles',
      settings: 'Configuraci√≥n',
      app_theme: 'Tema de la Aplicaci√≥n',
      dark: 'Oscuro',
      light: 'Claro',
      custom: 'Personalizado',
      custom_color: 'Color Personalizado',
      language: 'Idioma',
      spanish: 'Espa√±ol',
      english: 'English',
      notifications: 'Notificaciones',
      email_notifications: 'Notificaciones por Email',
      sms_notifications: 'Notificaciones por SMS',
      font_size: 'Tama√±o de Fuente',
      small: 'Peque√±o',
      medium: 'Mediano',
      large: 'Grande',
      currency: 'Formato de Moneda',
      usd: 'USD',
      dop: 'DOP',
      save_settings: 'Guardar Configuraci√≥n',
      home: 'Inicio',
      history: 'Historial',
      profile: 'Perfil',
      documents: 'Documentos',
      loan_details: 'Detalles del Pr√©stamo',
      select_profile_picture: 'Seleccionar Foto de Perfil',
      upload_image: 'Subir Imagen',
      save: 'Guardar',
      cancel: 'Cancelar',
      close: 'Cerrar',
      accept: 'Aceptar',
      info: 'Informaci√≥n',
      download: 'Descargar',
      no_payments: 'No hay pagos registrados',
      no_matching_payments: 'No se encontraron pagos que coincidan con los criterios',
      loan_completed: '¬°Pr√©stamo pagado completamente!',
      payment_due: 'Pr√≥ximo pago en {days} d√≠as',
      payment_late: 'Pago atrasado por {days} d√≠as',
      late_payment_alert: '¬°Atenci√≥n! Tiene un pago atrasado por {days} d√≠as',
      progress: '{percent}% completado',
      original_amount: 'Monto original',
      interest_rate: 'Tasa de inter√©s',
      frequency: 'Frecuencia',
      next_payment: 'Pr√≥ximo pago',
      next_payment_amount: 'Monto pr√≥ximo pago',
      payments_made: 'Pagos realizados',
      payments_pending: 'Pagos pendientes',
      biweekly: 'Quincenal',
      monthly: 'Mensual',
      completed: 'Completado',
      status: 'Estado',
      'Pr√©stamo': 'Pr√©stamo',
      'Fecha': 'Fecha',
      'Monto': 'Monto',
      'Tipo': 'Tipo',
      'Mora': 'Mora',
      'Registrado por': 'Registrado por'
    },
    en: {
      login: 'Log In',
      view_details: 'View Details',
      loan_balance: 'Outstanding Balance',
      loan_progress: 'Loan Progress',
      loading_progress: 'Loading progress...',
      payment_history: 'Payment History',
      loading_history: 'Loading payment history...',
      all: 'All',
      full: 'Full',
      capital: 'Capital',
      interest: 'Interest',
      late: 'With Late Fee',
      my_profile: 'My Profile',
      full_name: 'Full Name',
      id: 'Identification',
      phone: 'Phone',
      address: 'Address',
      nationality: 'Nationality',
      change_profile_picture: 'Change Profile Picture',
      change_password: 'Change Password',
      current_pin: 'Current PIN',
      new_pin: 'New PIN',
      confirm_pin: 'Confirm New PIN',
      logout: 'Log Out',
      my_documents: 'My Documents',
      no_documents: 'No documents available',
      settings: 'Settings',
      app_theme: 'App Theme',
      dark: 'Dark',
      light: 'Light',
      custom: 'Custom',
      custom_color: 'Custom Color',
      language: 'Language',
      spanish: 'Spanish',
      english: 'English',
      notifications: 'Notifications',
      email_notifications: 'Email Notifications',
      sms_notifications: 'SMS Notifications',
      font_size: 'Font Size',
      small: 'Small',
      medium: 'Medium',
      large: 'Large',
      currency: 'Currency Format',
      usd: 'USD',
      dop: 'DOP',
      save_settings: 'Save Settings',
      home: 'Home',
      history: 'History',
      profile: 'Profile',
      documents: 'Documents',
      loan_details: 'Loan Details',
      select_profile_picture: 'Select Profile Picture',
      upload_image: 'Upload Image',
      save: 'Save',
      cancel: 'Cancel',
      close: 'Close',
      accept: 'Accept',
      info: 'Information',
      download: 'Download',
      no_payments: 'No payments registered',
      no_matching_payments: 'No payments found matching the criteria',
      loan_completed: 'Loan fully paid!',
      payment_due: 'Next payment in {days} days',
      payment_late: 'Payment overdue by {days} days',
      late_payment_alert: 'Attention! You have a payment overdue by {days} days',
      progress: '{percent}% completed',
      original_amount: 'Original Amount',
      interest_rate: 'Interest Rate',
      frequency: 'Frequency',
      next_payment: 'Next Payment',
      next_payment_amount: 'Next Payment Amount',
      payments_made: 'Payments Made',
      payments_pending: 'Payments Pending',
      biweekly: 'Biweekly',
      monthly: 'Monthly',
      completed: 'Completed',
      status: 'Status',
      'Pr√©stamo': 'Loan',
      'Fecha': 'Date',
      'Monto': 'Amount',
      'Tipo': 'Type',
      'Mora': 'Late Fee',
      'Registrado por': 'Recorded by'
    }
  };

  // Initialization
  document.addEventListener('DOMContentLoaded', () => {
    showLoading();
    setupEventListeners();
    loadUserSettings().then(() => hideLoading());
  });

  // Setup Event Listeners
  function setupEventListeners() {
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        navigateToSection(item.dataset.section);
      });
    });
    document.getElementById('detailsBtn').addEventListener('click', showLoanDetails);
    document.getElementById('historySearch').addEventListener('input', filterPaymentHistory);
    document.getElementById('historyFilter').addEventListener('change', filterPaymentHistory);
    document.getElementById('changeAvatarBtn').addEventListener('click', showAvatarModal);
    document.getElementById('saveAvatarBtn').addEventListener('click', saveAvatar);
    document.getElementById('profileImageUpload').addEventListener('change', handleImageUpload);
    document.getElementById('changePasswordBtn').addEventListener('click', showPasswordModal);
    document.getElementById('passwordForm').addEventListener('submit', changePassword);
    document.getElementById('logoutBtn').addEventListener('click', logout);
    document.querySelectorAll('.theme-option').forEach(option => {
      option.addEventListener('click', selectTheme);
    });
    document.getElementById('customColorPicker').addEventListener('input', updateCustomColor);
    document.getElementById('languageSelector').addEventListener('change', updateLanguage);
    document.getElementById('fontSizeSelector').addEventListener('change', updateFontSize);
    document.getElementById('currencySelector').addEventListener('change', updateCurrency);
    document.getElementById('emailNotifications').addEventListener('change', updateNotifications);
    document.getElementById('smsNotifications').addEventListener('change', updateNotifications);
    document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
  }

  // Handle Login
  async function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('loginUsername').value.trim();
    const pin = document.getElementById('loginPin').value.trim();
    
    if (!username || !pin || pin.length !== 4 || !/^\d{4}$/.test(pin)) {
      showAlert(translate('Credenciales inv√°lidas o PIN no v√°lido'), 'danger', 'loginAlert');
      return;
    }

    showLoading();
    try {
      // Primero buscamos en LoanUsers (sistema nuevo)
      let q = query(collection(db, "LoanUsers"), where("username", "==", username), where("pin", "==", pin));
      let querySnapshot = await getDocs(q);
      
      if (querySnapshot.empty) {
        // Si no encontramos en LoanUsers, buscamos en Users (sistema anterior)
        q = query(collection(db, "Users"), where("username", "==", username), where("pin", "==", pin));
        querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
          showAlert(translate('Credenciales incorrectas'), 'danger', 'loginAlert');
          hideLoading();
          return;
        }
      }

      const userDoc = querySnapshot.docs[0];
      currentUser = { id: userDoc.id, ...userDoc.data() };

      // Cargar configuraci√≥n del usuario
      await loadUserSettings();

      // Buscar pr√©stamos asociados al cliente (compatible con ambos sistemas)
      let clientId = currentUser.clientId || currentUser.id; // clientId para sistema nuevo, id para sistema antiguo
      
      // Buscar pr√©stamos activos para este cliente
      q = query(collection(db, "Loans"), 
           where("client.id", "==", clientId),
           where("status", "in", ["active", "overdue"]));
      
      const loansSnapshot = await getDocs(q);
      
      if (loansSnapshot.empty) {
        showAlert(translate('No se encontr√≥ pr√©stamo activo asociado a este usuario'), 'danger', 'loginAlert');
        hideLoading();
        return;
      }

      // Tomar el primer pr√©stamo encontrado (podr√≠a modificarse para manejar m√∫ltiples pr√©stamos)
      const loanDoc = loansSnapshot.docs[0];
      currentLoan = { id: loanDoc.id, ...loanDoc.data() };

      // Actualizar el usuario con el ID del pr√©stamo si es necesario (para compatibilidad con sistema nuevo)
      if (!currentUser.loanIds) {
        currentUser.loanIds = [currentLoan.id];
        const userRef = doc(db, querySnapshot.docs[0].ref.parent.path, currentUser.id);
        await updateDoc(userRef, { loanIds: [currentLoan.id] });
      }

      // Cargar informaci√≥n de la empresa
      await loadCompanyInfo();

      showClientSection();
      loadClientData();
    } catch (error) {
      console.error("Error al iniciar sesi√≥n: ", error);
      showAlert(translate('Ocurri√≥ un error al iniciar sesi√≥n'), 'danger', 'loginAlert');
    } finally {
      hideLoading();
    }
  }

  // Cargar informaci√≥n de la empresa desde Firebase
  async function loadCompanyInfo() {
    try {
      // Buscar en la colecci√≥n "informacionCompany"
      const companyQuery = query(collection(db, "informacionCompany"));
      const querySnapshot = await getDocs(companyQuery);
      
      if (!querySnapshot.empty) {
        // Tomar el primer documento de la colecci√≥n (asumimos que solo hay uno)
        const companyData = querySnapshot.docs[0].data();
        
        // Actualizar companyInfo con los datos recuperados
        companyInfo = {
          nombreEmpresa: companyData.nombreEmpresa || "Empresa de Pr√©stamos",
          rnc: companyData.rnc || "123-456789-1",
          phone: companyData.telefono || "809-555-5555",
          address: companyData.direccion || "Calle Principal #123, Santo Domingo",
          fotoURL: companyData.fotoURL || "logo.png"
        };
        
        // Mostrar logo y nombre en el header
        if (companyInfo.fotoURL) {
          document.getElementById('companyLogoHeader').src = companyInfo.fotoURL;
          document.getElementById('companyLogoHeader').style.display = 'block';
        }
        if (companyInfo.nombreEmpresa) {
          document.getElementById('companyNameHeader').textContent = companyInfo.nombreEmpresa;
        }
      }
    } catch (error) {
      console.error("Error al cargar informaci√≥n de la empresa:", error);
      // Mantener los valores por defecto si hay un error
    }
  }

  // Formatear n√∫meros con comas y puntos (ejemplo: 20,550.00)
  function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).format(amount);
  }

  // Show Client Section
  function showClientSection() {
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('client-section').style.display = 'block';
    navigateToSection('summary');
  }

  // Load Client Data
  function loadClientData() {
    document.getElementById('clientName').textContent = currentLoan.client.name;
    document.getElementById('clientId').textContent = `ID: ${currentLoan.client.id}`;
    updateBalanceDisplay();

    const paymentsMade = currentLoan.payments ? currentLoan.payments.length : 0;
    const totalPayments = currentLoan.paymentSchedule.length;
    const progress = (paymentsMade / totalPayments) * 100;
    document.getElementById('progressFill').style.width = `${progress}%`;

    if (currentUser.avatar) {
      const avatarDiv = document.getElementById('clientAvatar');
      avatarDiv.innerHTML = currentUser.avatar.includes('<i') ? currentUser.avatar : `<img src="${currentUser.avatar}" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
    }

    loadLoanProgress();
    loadPaymentHistory();
    loadProfileData();
    loadDocuments();
  }

  // Update Balance Display con formato de moneda
  function updateBalanceDisplay() {
    const balance = currentLoan.balance;
    const currencySymbol = userSettings.currency === 'USD' ? '$' : 'RD$';
    document.getElementById('loanBalance').textContent = `${currencySymbol}${formatCurrency(balance)}`;
  }

  // Show Loan Details in Modal con formato de moneda
  function showLoanDetails() {
    const nextPayment = currentLoan.paymentSchedule.find(p => p.status === 'pending');
    const paymentsMade = currentLoan.payments ? currentLoan.payments.length : 0;
    const totalPayments = currentLoan.paymentSchedule.length;
    const currencySymbol = userSettings.currency === 'USD' ? '$' : 'RD$';

    const content = `
      <div class="loan-summary-item">
        <span class="loan-detail-label" data-lang="original_amount">${translate('original_amount')}:</span>
        <span>${currencySymbol}${formatCurrency(currentLoan.amount)}</span>
      </div>
      <div class="loan-summary-item">
        <span class="loan-detail-label" data-lang="interest_rate">${translate('interest_rate')}:</span>
        <span>${currentLoan.interestRate}%</span>
      </div>
      <div class="loan-summary-item">
        <span class="loan-detail-label" data-lang="frequency">${translate('frequency')}:</span>
        <span data-lang="${currentLoan.frequency === 'biweekly' ? 'biweekly' : 'monthly'}">${translate(currentLoan.frequency === 'biweekly' ? 'biweekly' : 'monthly')}</span>
      </div>
      <div class="loan-summary-item">
        <span class="loan-detail-label" data-lang="next_payment">${translate('next_payment')}:</span>
        <span>${nextPayment ? new Date(nextPayment.dueDate).toLocaleDateString() : 'N/A'}</span>
      </div>
      <div class="loan-summary-item">
        <span class="loan-detail-label" data-lang="next_payment_amount">${translate('next_payment_amount')}:</span>
        <span>${nextPayment ? `${currencySymbol}${formatCurrency(nextPayment.amount)}` : 'N/A'}</span>
      </div>
      <div class="loan-summary-item">
        <span class="loan-detail-label" data-lang="payments_made">${translate('payments_made')}:</span>
        <span>${paymentsMade}</span>
      </div>
      <div class="loan-summary-item">
        <span class="loan-detail-label" data-lang="payments_pending">${translate('payments_pending')}:</span>
        <span>${totalPayments - paymentsMade}</span>
      </div>
      ${nextPayment && nextPayment.lateFee && nextPayment.lateFee > 0 ? `
      <div class="loan-summary-item">
        <span class="loan-detail-label">Monto de mora:</span>
        <span>${currencySymbol}${formatCurrency(nextPayment.lateFee)}</span>
      </div>
      ` : ''}
    `;
    document.getElementById('loanDetailsContent').innerHTML = content;
    document.getElementById('detailsModal').classList.add('active');
    updateLanguage();
  }

  // Load Loan Progress
  function loadLoanProgress() {
    const container = document.getElementById('loanProgress');
    const paymentsMade = currentLoan.payments ? currentLoan.payments.length : 0;
    const totalPayments = currentLoan.paymentSchedule.length;
    const progress = (paymentsMade / totalPayments) * 100;

    let statusHTML = '';
    if (currentLoan.balance <= 0) {
      statusHTML = `
        <div class="alert alert-success">
          <i class="fas fa-check-circle"></i>
          <span data-lang="loan_completed">${translate('loan_completed')}</span>
        </div>
        <div class="loan-summary-item">
          <span class="loan-detail-label" data-lang="status">${translate('status')}:</span>
          <span data-lang="completed">${translate('completed')}</span>
        </div>
      `;
      document.getElementById('latePaymentAlert').style.display = 'none';
      document.getElementById('latePaymentText').style.display = 'none';
    } else {
      const nextPayment = currentLoan.paymentSchedule.find(p => p.status === 'pending');
      const today = new Date();
      let statusClass = '';
      let message = '';

      if (nextPayment) {
        const dueDate = new Date(nextPayment.dueDate);
        const daysUntilDue = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
        if (daysUntilDue < 0) {
          statusClass = 'alert-danger';
          message = translate('payment_late').replace('{days}', -daysUntilDue);
          document.getElementById('latePaymentAlert').style.display = 'flex';
          document.getElementById('latePaymentMessage').textContent = translate('late_payment_alert').replace('{days}', -daysUntilDue);
          document.getElementById('latePaymentText').style.display = 'block';
          document.getElementById('latePaymentText').textContent = translate('payment_late').replace('{days}', -daysUntilDue);
        } else {
          statusClass = daysUntilDue <= 5 ? 'alert-warning' : 'alert-success';
          message = translate('payment_due').replace('{days}', daysUntilDue);
          document.getElementById('latePaymentAlert').style.display = 'none';
          document.getElementById('latePaymentText').style.display = 'none';
        }
      } else {
        statusClass = 'alert-success';
        message = translate('Todos los pagos est√°n al d√≠a');
        document.getElementById('latePaymentAlert').style.display = 'none';
        document.getElementById('latePaymentText').style.display = 'none';
      }

      statusHTML = `
        <div class="alert ${statusClass}">
          <i class="fas fa-info-circle"></i>
          <span>${message}</span>
        </div>
        <div class="loan-summary-item">
          <span class="loan-detail-label" data-lang="progress">${translate('progress').replace('{percent}', '')}:</span>
          <span data-lang="progress" data-progress="${progress.toFixed(0)}">${translate('progress').replace('{percent}', progress.toFixed(0))}</span>
        </div>
      `;
    }

    container.innerHTML = statusHTML;
    updateLanguage();
  }

  // Load Payment History con formato de moneda
  function loadPaymentHistory() {
    const container = document.getElementById('paymentHistory');
    paymentReceipts = [];

    if (!currentLoan.payments || currentLoan.payments.length === 0) {
      container.innerHTML = `
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-circle"></i>
          <span data-lang="no_payments">${translate('no_payments')}</span>
        </div>
      `;
      return;
    }

    container.innerHTML = '';
    const sortedPayments = [...currentLoan.payments].sort((a, b) => b.date.toDate() - a.date.toDate());

    sortedPayments.forEach(payment => {
      const paymentDate = payment.date.toDate();
      const typeClass = payment.lateFee && payment.lateFee > 0 ? 'late' : payment.type;
      const typeText = getPaymentTypeText(payment.type) + (payment.lateFee && payment.lateFee > 0 ? ` ${translate('late')}` : '');
      const currencySymbol = userSettings.currency === 'USD' ? '$' : 'RD$';

      paymentReceipts.push({
        id: `${currentLoan.id}_${paymentDate.toISOString()}`,
        clientName: currentLoan.client.name,
        clientId: currentLoan.client.id,
        loanId: currentLoan.id,
        date: paymentDate,
        amount: payment.amount,
        type: payment.type,
        lateFee: payment.lateFee || 0,
        recordedBy: payment.recordedBy || translate('Administrador'),
        companyInfo: companyInfo // Usamos la informaci√≥n de la empresa cargada
      });

      const paymentItem = document.createElement('div');
      paymentItem.className = 'payment-item';
      paymentItem.innerHTML = `
        <div>
          <div class="payment-amount">${currencySymbol}${formatCurrency(payment.amount)}</div>
          <div class="payment-date">${paymentDate.toLocaleDateString()} ${paymentDate.toLocaleTimeString()}</div>
        </div>
        <div>
          <span class="payment-type ${typeClass}">${typeText}</span>
        </div>
      `;
      container.appendChild(paymentItem);
    });
    updateLanguage();
  }

  // Filter Payment History
  function filterPaymentHistory() {
    const searchTerm = document.getElementById('historySearch').value.toLowerCase();
    const filterType = document.getElementById('historyFilter').value;
    const container = document.getElementById('paymentHistory');

    if (!currentLoan.payments || currentLoan.payments.length === 0) {
      container.innerHTML = `
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-circle"></i>
          <span data-lang="no_payments">${translate('no_payments')}</span>
        </div>
      `;
      return;
    }

    const sortedPayments = [...currentLoan.payments].sort((a, b) => b.date.toDate() - a.date.toDate());
    const filteredPayments = sortedPayments.filter(payment => {
      const paymentDate = payment.date.toDate().toLocaleDateString().toLowerCase();
      const isDateMatch = searchTerm ? paymentDate.includes(searchTerm) : true;
      const isTypeMatch = filterType === 'all' || 
                         (filterType === 'late' && payment.lateFee && payment.lateFee > 0) || 
                         (filterType !== 'late' && payment.type === filterType);
      return isDateMatch && isTypeMatch;
    });

    container.innerHTML = '';
    if (filteredPayments.length === 0) {
      container.innerHTML = `
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-circle"></i>
          <span data-lang="no_matching_payments">${translate('no_matching_payments')}</span>
        </div>
      `;
      return;
    }

    filteredPayments.forEach(payment => {
      const paymentDate = payment.date.toDate();
      const typeClass = payment.lateFee && payment.lateFee > 0 ? 'late' : payment.type;
      const typeText = getPaymentTypeText(payment.type) + (payment.lateFee && payment.lateFee > 0 ? ` ${translate('late')}` : '');
      const currencySymbol = userSettings.currency === 'USD' ? '$' : 'RD$';

      const paymentItem = document.createElement('div');
      paymentItem.className = 'payment-item';
      paymentItem.innerHTML = `
        <div>
          <div class="payment-amount">${currencySymbol}${formatCurrency(payment.amount)}</div>
          <div class="payment-date">${paymentDate.toLocaleDateString()} ${paymentDate.toLocaleTimeString()}</div>
        </div>
        <div>
          <span class="payment-type ${typeClass}">${typeText}</span>
        </div>
      `;
      container.appendChild(paymentItem);
    });
    updateLanguage();
  }

  // Get Payment Type Text
  function getPaymentTypeText(type) {
    const types = {
      full: translate('full'),
      interest: translate('interest'),
      capital: translate('capital')
    };
    return types[type] || type;
  }

  // Load Profile Data
  function loadProfileData() {
    document.getElementById('profileName').textContent = currentLoan.client.name;
    document.getElementById('profileId').textContent = currentLoan.client.id;
    document.getElementById('profilePhone').textContent = currentLoan.client.phone || '-';
    document.getElementById('profileAddress').textContent = currentLoan.client.address || '-';
    document.getElementById('profileNationality').textContent = currentLoan.client.nationality || '-';
    document.getElementById('profileCompany').textContent = currentLoan.client.company || '-';
    document.getElementById('profileCompanyTime').textContent = currentLoan.client.companyTime || '-';
    document.getElementById('profileLoanStartDate').textContent = currentLoan.startDate ? new Date(currentLoan.startDate).toLocaleDateString() : '-';
    updateLanguage();
  }

  // Show Avatar Modal
  function showAvatarModal() {
    const avatarSelector = document.getElementById('avatarSelector');
    avatarSelector.innerHTML = '';

    const icons = [
      'fa-user', 'fa-user-tie', 'fa-user-astronaut', 'fa-user-ninja', 'fa-user-secret',
      'fa-user-doctor', 'fa-user-graduate', 'fa-user-shield', 'fa-user-cog', 'fa-user-clock',
      'fa-robot', 'fa-cat', 'fa-dog', 'fa-fish', 'fa-dragon',
      'fa-smile', 'fa-heart', 'fa-star', 'fa-moon', 'fa-sun', 'fa-tree', 'fa-leaf',
      'fa-rocket', 'fa-camera'
    ];

    icons.forEach(icon => {
      const avatarOption = document.createElement('div');
      avatarOption.className = `avatar-option ${currentUser.avatar === `<i class="fas ${icon}"></i>` ? 'selected' : ''}`;
      avatarOption.innerHTML = `<i class="fas ${icon}"></i>`;
      avatarOption.dataset.avatar = `<i class="fas ${icon}"></i>`;
      avatarOption.addEventListener('click', selectAvatar);
      avatarSelector.appendChild(avatarOption);
    });

    document.getElementById('profileImageUpload').value = '';
    document.getElementById('avatarModal').classList.add('active');
    updateLanguage();
  }

  // Select Avatar
  function selectAvatar(e) {
    document.querySelectorAll('.avatar-option').forEach(option => {
      option.classList.remove('selected');
    });
    e.currentTarget.classList.add('selected');
    currentUser.avatar = e.currentTarget.dataset.avatar;
  }

  // Handle Image Upload
  function handleImageUpload(e) {
    const file = e.target.files[0];
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (event) => {
        currentUser.avatar = event.target.result;
        document.querySelectorAll('.avatar-option').forEach(option => {
          option.classList.remove('selected');
        });
      };
      reader.readAsDataURL(file);
    } else {
      showInfoModal(translate('info'), translate('Por favor, seleccione una imagen v√°lida'));
    }
  }

  // Save Avatar
  async function saveAvatar() {
    if (!currentUser.avatar) {
      showInfoModal(translate('info'), translate('Por favor, seleccione un avatar o suba una imagen'));
      return;
    }

    showLoading();
    try {
      const avatarDiv = document.getElementById('clientAvatar');
      if (currentUser.avatar.startsWith('data:image')) {
        avatarDiv.innerHTML = `<img src="${currentUser.avatar}" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
      } else {
        avatarDiv.innerHTML = currentUser.avatar;
      }

      const userRef = doc(db, "LoanUsers", currentUser.id);
      await updateDoc(userRef, { avatar: currentUser.avatar });
      closeModal();
      showInfoModal(translate('info'), translate('Foto de perfil guardada correctamente'));
    } catch (error) {
      console.error("Error al guardar avatar: ", error);
      showInfoModal(translate('info'), translate('No se pudo guardar la imagen de perfil'));
    } finally {
      hideLoading();
    }
  }

  // Show Password Modal
  function showPasswordModal() {
    document.getElementById('passwordForm').reset();
    document.getElementById('passwordAlert').style.display = 'none';
    document.getElementById('passwordModal').classList.add('active');
    updateLanguage();
  }

  // Change Password
  async function changePassword(e) {
    e.preventDefault();
    const currentPin = document.getElementById('currentPin').value.trim();
    const newPin = document.getElementById('newPin').value.trim();
    const confirmPin = document.getElementById('confirmPin').value.trim();

    if (!currentPin || !newPin || !confirmPin || newPin.length !== 4 || !/^\d{4}$/.test(newPin)) {
      showAlert(translate('Por favor, ingrese un PIN v√°lido de 4 d√≠gitos'), 'danger', 'passwordAlert');
      return;
    }

    if (newPin !== confirmPin) {
      showAlert(translate('Los nuevos PIN no coinciden'), 'danger', 'passwordAlert');
      return;
    }

    if (currentPin !== currentUser.pin) {
      showAlert(translate('El PIN actual es incorrecto'), 'danger', 'passwordAlert');
      return;
    }

    showLoading();
    try {
      const userRef = doc(db, "LoanUsers", currentUser.id);
      await updateDoc(userRef, { pin: newPin });
      currentUser.pin = newPin;
      closeModal();
      showInfoModal(translate('info'), translate('Contrase√±a actualizada correctamente'));
    } catch (error) {
      console.error("Error al cambiar contrase√±a: ", error);
      showAlert(translate('No se pudo actualizar la contrase√±a'), 'danger', 'passwordAlert');
    } finally {
      hideLoading();
    }
  }

  // Load Documents
  function loadDocuments() {
    const container = document.getElementById('documentList');
    const alert = document.getElementById('documentsAlert');

    container.innerHTML = '';

    if (!paymentReceipts || paymentReceipts.length === 0) {
      alert.style.display = 'flex';
      return;
    }

    alert.style.display = 'none';

    paymentReceipts.forEach(receipt => {
      const documentItem = document.createElement('div');
      documentItem.className = 'document-item';
      const currencySymbol = userSettings.currency === 'USD' ? '$' : 'RD$';
      documentItem.innerHTML = `
        <i class="fas fa-receipt document-icon"></i>
        <span class="document-name">Recibo ${receipt.date.toLocaleDateString()} - ${currencySymbol}${formatCurrency(receipt.amount)}</span>
        <i class="fas fa-eye document-action" onclick="previewDocument('receipt', '${receipt.id}')"></i>
      `;
      container.appendChild(documentItem);
    });
    updateLanguage();
  }

  // Preview Document
  window.previewDocument = async function(type, receiptId = null) {
    const previewContainer = document.getElementById('documentPreview');
    const modalTitle = document.getElementById('documentModalTitle');
    const modalFooter = document.getElementById('documentModalFooter');
    const currencySymbol = userSettings.currency === 'USD' ? '$' : 'RD$';

    previewContainer.innerHTML = '';
    modalFooter.innerHTML = `<button class="btn btn-info" onclick="closeModal()" data-lang="close">${translate('close')}</button>`;

    if (type === 'receipt' && receiptId) {
      const receipt = paymentReceipts.find(r => r.id === receiptId);
      if (receipt) {
        modalTitle.textContent = `Recibo ${receipt.date.toLocaleDateString()}`;
        const content = `
          <div class="receipt-preview" id="receiptPreview_${receiptId}">
            <div style="text-align: center; margin-bottom: 15px;">
              ${receipt.companyInfo.fotoURL ? 
                `<img src="${receipt.companyInfo.fotoURL}" alt="Logo" style="max-width: 120px; max-height: 60px;">` : 
                `<i class="fas fa-building" style="font-size: 3rem; color: #15a086;"></i>`}
              <h3>${receipt.companyInfo.nombreEmpresa || 'Empresa de Pr√©stamos'}</h3>
              <p>RNC: ${receipt.companyInfo.rnc || '123-456789-1'}</p>
              <p>${receipt.companyInfo.phone || '809-555-5555'} - ${receipt.companyInfo.address || 'Calle Principal #123, Santo Domingo'}</p>
            </div>
            <hr>
            <h3 style="text-align: center;">RECIBO DE PAGO</h3>
            <p><strong>${translate('full_name')}:</strong> ${receipt.clientName}</p>
            <p><strong>${translate('id')}:</strong> ${receipt.clientId}</p>
            <p><strong>${translate('Pr√©stamo')}:</strong> ${receipt.loanId}</p>
            <p><strong>${translate('Fecha')}:</strong> ${receipt.date.toLocaleDateString()} ${receipt.date.toLocaleTimeString()}</p>
            <p><strong>${translate('Monto')}:</strong> ${currencySymbol}${formatCurrency(receipt.amount)}</p>
            <p><strong>${translate('Tipo')}:</strong> ${getPaymentTypeText(receipt.type)}</p>
            ${receipt.lateFee > 0 ? `<p><strong>${translate('Mora')}:</strong> ${currencySymbol}${formatCurrency(receipt.lateFee)}</p>` : ''}
            <p><strong>${translate('Registrado por')}:</strong> ${receipt.recordedBy}</p>
          </div>
        `;
        previewContainer.innerHTML = content;

        if (isPC) {
          modalFooter.innerHTML += `
            <button class="btn btn-success" onclick="downloadReceipt('${receiptId}')" data-lang="download">${translate('download')}</button>
          `;
        }
      } else {
        showInfoModal(translate('info'), translate('No se encontr√≥ el recibo solicitado'));
        return;
      }
    }

    document.getElementById('documentModal').classList.add('active');
    updateLanguage();
  }

  // Download Receipt
  window.downloadReceipt = async function(receiptId) {
    showLoading();
    try {
      const receipt = paymentReceipts.find(r => r.id === receiptId);
      if (!receipt) {
        showInfoModal(translate('info'), translate('No se encontr√≥ el recibo solicitado'));
        hideLoading();
        return;
      }

      const preview = document.getElementById(`receiptPreview_${receiptId}`);
      const canvas = await html2canvas(preview, { backgroundColor: '#ffffff', scale: 2 });
      const dataUrl = canvas.toDataURL('image/jpeg', 1.0);

      const link = document.createElement('a');
      link.href = dataUrl;
      link.download = `recibo_pago_${receiptId}.jpg`;
      link.click();
      showInfoModal(translate('info'), translate('Recibo descargado exitosamente'));
    } catch (error) {
      console.error("Error al descargar recibo: ", error);
      showInfoModal(translate('info'), translate('Error al descargar el recibo'));
    } finally {
      hideLoading();
    }
  }

  // Select Theme
  function selectTheme(e) {
    document.querySelectorAll('.theme-option').forEach(option => {
      option.classList.remove('selected');
    });
    e.target.classList.add('selected');
    userSettings.theme = e.target.dataset.theme;
    document.getElementById('customColorContainer').style.display = userSettings.theme === 'custom' ? 'block' : 'none';
    applyTheme();
    updateLanguage();
  }

  // Update Custom Color
  function updateCustomColor(e) {
    userSettings.customColor = e.target.value;
    applyTheme();
  }

  // Apply Theme
  function applyTheme() {
    document.body.classList.remove('light-theme');
    document.documentElement.style.setProperty('--primary-color', '#15a086');
    document.documentElement.style.setProperty('--primary-dark', '#127c68');

    if (userSettings.theme === 'light') {
      document.body.classList.add('light-theme');
    } else if (userSettings.theme === 'custom') {
      document.documentElement.style.setProperty('--primary-color', userSettings.customColor);
      document.documentElement.style.setProperty('--primary-dark', darkenColor(userSettings.customColor, 0.8));
      document.getElementById('customColorPicker').value = userSettings.customColor;
    }

    document.querySelectorAll('.theme-option').forEach(option => {
      option.classList.toggle('selected', option.dataset.theme === userSettings.theme);
    });
    document.getElementById('customColorContainer').style.display = userSettings.theme === 'custom' ? 'block' : 'none';
  }

  // Darken Color
  function darkenColor(hex, factor) {
    hex = hex.replace('#', '');
    const r = parseInt(hex.substr(0, 2), 16) * factor;
    const g = parseInt(hex.substr(2, 2), 16) * factor;
    const b = parseInt(hex.substr(4, 2), 16) * factor;
    return `#${Math.round(r).toString(16).padStart(2, '0')}${Math.round(g).toString(16).padStart(2, '0')}${Math.round(b).toString(16).padStart(2, '0')}`;
  }

  // Update Language
  function updateLanguage() {
    userSettings.language = document.getElementById('languageSelector').value;
    document.querySelectorAll('[data-lang]').forEach(element => {
      const key = element.dataset.lang;
      if (element.dataset.progress) {
        element.textContent = translate('progress').replace('{percent}', element.dataset.progress);
      } else {
        element.textContent = translate(key);
      }
    });
  }

  // Update Font Size
  function updateFontSize() {
    userSettings.fontSize = document.getElementById('fontSizeSelector').value;
    document.body.classList.remove('font-small', 'font-medium', 'font-large');
    document.body.classList.add(`font-${userSettings.fontSize}`);
  }

  // Update Currency
  function updateCurrency() {
    userSettings.currency = document.getElementById('currencySelector').value;
    updateBalanceDisplay();
    loadPaymentHistory();
    loadDocuments();
    if (document.getElementById('detailsModal').classList.contains('active')) {
      showLoanDetails();
    }
  }

  // Update Notifications
  function updateNotifications() {
    userSettings.emailNotifications = document.getElementById('emailNotifications').checked;
    userSettings.smsNotifications = document.getElementById('smsNotifications').checked;
  }

  // Save Settings
  async function saveSettings() {
    showLoading();
    try {
      const userRef = doc(db, "LoanUsers", currentUser.id);
      await updateDoc(userRef, { settings: userSettings });
      showInfoModal(translate('info'), translate('Configuraci√≥n guardada correctamente'));
    } catch (error) {
      console.error("Error al guardar ajustes: ", error);
      showInfoModal(translate('info'), translate('No se pudo guardar la configuraci√≥n'));
    } finally {
      hideLoading();
    }
  }

  // Load User Settings
  async function loadUserSettings() {
    try {
      if (currentUser && currentUser.id) {
        const userRef = doc(db, "LoanUsers", currentUser.id);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists() && userSnap.data().settings) {
          userSettings = { ...userSettings, ...userSnap.data().settings };
        }
      }

      document.getElementById('languageSelector').value = userSettings.language;
      document.getElementById('fontSizeSelector').value = userSettings.fontSize;
      document.getElementById('currencySelector').value = userSettings.currency;
      document.getElementById('emailNotifications').checked = userSettings.emailNotifications;
      document.getElementById('smsNotifications').checked = userSettings.smsNotifications;

      applyTheme();
      updateLanguage();
      updateFontSize();
      updateCurrency();
    } catch (error) {
      console.error("Error al cargar ajustes: ", error);
    }
  }

  // Navigate Between Sections
  function navigateToSection(section) {
    document.querySelectorAll('.nav-item').forEach(item => {
      item.classList.toggle('active', item.dataset.section === section);
    });
    document.querySelectorAll('.section').forEach(sec => {
      sec.classList.toggle('active', sec.id === `${section}-section`);
    });
    updateLanguage();
  }

  // Show Alert
  function showAlert(message, type, alertId = 'loginAlert') {
    const alert = document.getElementById(alertId);
    alert.style.display = 'flex';
    alert.className = `alert alert-${type}`;
    document.getElementById(`${alertId}Message`).textContent = message;
  }

  // Show Info Modal
  function showInfoModal(title, message) {
    document.getElementById('infoModalTitle').textContent = title;
    document.getElementById('infoModalMessage').textContent = message;
    document.getElementById('infoModal').classList.add('active');
    updateLanguage();
  }

  // Close Modal
  window.closeModal = function() {
    document.querySelectorAll('.modal').forEach(modal => {
      modal.classList.remove('active');
    });
  };

  // Show Loading
  function showLoading() {
    document.getElementById('loginSpinner').classList.add('active');
  }

  // Hide Loading
  function hideLoading() {
    document.getElementById('loginSpinner').classList.remove('active');
  }

  // Logout
  function logout() {
    currentUser = null;
    currentLoan = null;
    paymentReceipts = [];
    companyInfo = null;
    document.getElementById('login-section').style.display = 'flex';
    document.getElementById('client-section').style.display = 'none';
    document.getElementById('loginForm').reset();
    document.getElementById('loginAlert').style.display = 'none';
    applyTheme();
    updateLanguage();
  }

  // Translate Function
  function translate(key) {
    return translations[userSettings.language][key] || key;
  }
</script>
</body>
</html>
