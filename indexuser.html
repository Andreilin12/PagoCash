<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cliente - Sistema de Préstamos</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #1abc9c;
      --primary-dark: #16a085;
      --secondary-color: #2a2a3f;
      --background-color: #2c3e50;
      --text-color: #ffffff;
      --text-light: #a8a8a8;
      --border-color: #444;
      --card-bg: #34495e;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --success-color: #2ecc71;
      --info-color: #3498db;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Estilos para la sección de login */
    #login-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 1rem;
      background-color: var(--secondary-color);
    }

    .login-container {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 2rem;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .login-title {
      text-align: center;
      margin-bottom: 1.5rem;
      color: var(--primary-color);
      font-size: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-light);
      font-weight: 500;
    }

    .form-control {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--background-color);
      color: var(--text-color);
      font-size: 1rem;
    }

    .btn {
      background-color: var(--primary-color);
      color: var(--text-color);
      border: none;
      border-radius: 8px;
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 100%;
    }

    .btn i {
      margin-right: 8px;
    }

    .btn:hover {
      background-color: var(--primary-dark);
    }

    /* Estilos para la sección del cliente (oculta inicialmente) */
    #client-section {
      display: none;
      flex: 1;
      padding-bottom: 70px; /* Espacio para el menú inferior */
    }

    .header-client {
      background-color: var(--secondary-color);
      padding: 1rem;
      text-align: center;
      position: relative;
    }

    .client-profile {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 1rem;
    }

    .client-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background-color: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1rem;
      font-size: 2rem;
      color: white;
    }

    .client-name {
      font-size: 1.2rem;
      font-weight: 500;
    }

    .client-id {
      color: var(--text-light);
      font-size: 0.9rem;
    }

    .main-container-client {
      padding: 1rem;
    }

    .card {
      background-color: var(--secondary-color);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .card-title {
      color: var(--primary-color);
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }

    .loan-summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border-color);
    }

    .loan-summary-item:last-child {
      border-bottom: none;
    }

    .loan-detail-label {
      color: var(--text-light);
    }

    .payment-history {
      max-height: 300px;
      overflow-y: auto;
    }

    .payment-item {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border-color);
    }

    .payment-item:last-child {
      border-bottom: none;
    }

    .payment-amount {
      color: var(--success-color);
      font-weight: 500;
    }

    .payment-date {
      font-size: 0.8rem;
      color: var(--text-light);
    }

    .payment-type {
      font-size: 0.8rem;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      background-color: rgba(52, 152, 219, 0.2);
    }

    .payment-type.capital {
      background-color: rgba(46, 204, 113, 0.2);
    }

    .payment-type.interest {
      background-color: rgba(241, 196, 15, 0.2);
    }

    .payment-type.late {
      background-color: rgba(231, 76, 60, 0.2);
    }

    /* Formulario de pago */
    .payment-form {
      margin-top: 1.5rem;
    }

    .form-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .form-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }

    .payment-options {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .payment-option {
      flex: 1;
    }

    .payment-option input {
      display: none;
    }

    .payment-option label {
      display: block;
      padding: 0.5rem;
      background-color: var(--background-color);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }

    .payment-option input:checked + label {
      background-color: var(--primary-color);
      color: white;
    }

    /* Menú inferior */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: var(--secondary-color);
      display: flex;
      justify-content: space-around;
      padding: 0.5rem 0;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
      z-index: 100;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--text-light);
      text-decoration: none;
      font-size: 0.8rem;
      padding: 0.5rem;
    }

    .nav-item i {
      font-size: 1.2rem;
      margin-bottom: 0.3rem;
    }

    .nav-item.active {
      color: var(--primary-color);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background-color: var(--secondary-color);
      padding: 2rem;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
    }

    .modal-title {
      margin-bottom: 1.5rem;
      color: var(--primary-color);
      text-align: center;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .btn-success {
      background-color: var(--success-color);
    }

    .btn-danger {
      background-color: var(--danger-color);
    }

    .btn-warning {
      background-color: var(--warning-color);
    }

    /* Alertas */
    .alert {
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
    }

    .alert-warning {
      background-color: rgba(243, 156, 18, 0.2);
      border-left: 4px solid var(--warning-color);
    }

    .alert-danger {
      background-color: rgba(231, 76, 60, 0.2);
      border-left: 4px solid var(--danger-color);
    }

    .alert i {
      margin-right: 0.5rem;
    }

    /* Responsive */
    @media (max-width: 480px) {
      .login-container {
        padding: 1.5rem;
      }
      
      .form-row {
        flex-direction: column;
        gap: 0;
      }
    }
  </style>
</head>
<body>
  <!-- Sección de Login -->
  <section id="login-section">
    <div class="login-container">
      <h1 class="login-title">Iniciar Sesión</h1>
      <form id="loginForm">
        <div class="form-group">
          <label for="loginUsername">Nombre de Usuario</label>
          <input type="text" id="loginUsername" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="loginPin">PIN (4 dígitos)</label>
          <input type="password" id="loginPin" class="form-control" minlength="4" maxlength="4" pattern="\d{4}" required>
        </div>
        <button type="submit" class="btn">
          <i class="fas fa-sign-in-alt"></i> Ingresar
        </button>
      </form>
    </div>
  </section>

  <!-- Sección del Cliente (oculta inicialmente) -->
  <section id="client-section">
    <div class="header-client">
      <div class="client-profile">
        <div class="client-avatar" id="clientAvatar">
          <i class="fas fa-user"></i>
        </div>
        <h2 class="client-name" id="clientName">Nombre del Cliente</h2>
        <span class="client-id" id="clientId">ID: 000-0000000-0</span>
      </div>
    </div>

    <div class="main-container-client">
      <!-- Resumen del Préstamo -->
      <div class="card">
        <h3 class="card-title">Resumen de tu Préstamo</h3>
        <div class="loan-summary-item">
          <span class="loan-detail-label">Monto original:</span>
          <span id="loanOriginalAmount">$0.00</span>
        </div>
        <div class="loan-summary-item">
          <span class="loan-detail-label">Saldo pendiente:</span>
          <span id="loanBalance">$0.00</span>
        </div>
        <div class="loan-summary-item">
          <span class="loan-detail-label">Próximo pago:</span>
          <span id="nextPaymentDate">--/--/----</span>
        </div>
        <div class="loan-summary-item">
          <span class="loan-detail-label">Monto a pagar:</span>
          <span id="nextPaymentAmount">$0.00</span>
        </div>
        <div class="loan-summary-item">
          <span class="loan-detail-label">Pagos realizados:</span>
          <span id="paymentsMade">0</span>
        </div>
        <div class="loan-summary-item">
          <span class="loan-detail-label">Pagos pendientes:</span>
          <span id="paymentsPending">0</span>
        </div>
      </div>

      <!-- Historial de Pagos -->
      <div class="card">
        <h3 class="card-title">Historial de Pagos</h3>
        <div class="payment-history" id="paymentHistory">
          <p>Cargando historial de pagos...</p>
        </div>
      </div>

      <!-- Formulario de Pago -->
      <div class="card">
        <h3 class="card-title">Realizar Pago</h3>
        <div id="paymentAlert" class="alert alert-warning" style="display: none;">
          <i class="fas fa-exclamation-circle"></i>
          <span id="paymentAlertMessage"></span>
        </div>
        
        <form id="paymentForm" class="payment-form">
          <input type="hidden" id="loanId">
          
          <div class="form-row">
            <div class="form-group">
              <label for="paymentAmount">Monto a pagar</label>
              <input type="number" id="paymentAmount" class="form-control" min="1" required>
            </div>
            <div class="form-group">
              <label for="paymentDate">Fecha</label>
              <input type="date" id="paymentDate" class="form-control" required>
            </div>
          </div>
          
          <div class="form-group">
            <label>Tipo de Pago</label>
            <div class="payment-options">
              <div class="payment-option">
                <input type="radio" id="paymentTypeFull" name="paymentType" value="full" checked>
                <label for="paymentTypeFull">Completo</label>
              </div>
              <div class="payment-option">
                <input type="radio" id="paymentTypeCapital" name="paymentType" value="capital">
                <label for="paymentTypeCapital">Capital</label>
              </div>
              <div class="payment-option">
                <input type="radio" id="paymentTypeInterest" name="paymentType" value="interest">
                <label for="paymentTypeInterest">Interés</label>
              </div>
            </div>
          </div>
          
          <div class="form-group" id="lateFeeContainer" style="display: none;">
            <label>
              <input type="checkbox" id="applyLateFee"> Incluir mora
            </label>
            <div id="lateFeeDetails" style="display: none; margin-top: 0.5rem;">
              <div class="form-group">
                <label for="lateFeeAmount">Monto de mora</label>
                <input type="number" id="lateFeeAmount" class="form-control" min="0" step="0.01" value="0">
              </div>
            </div>
          </div>
          
          <button type="submit" class="btn btn-success">
            <i class="fas fa-money-bill-wave"></i> Registrar Pago
          </button>
        </form>
      </div>
    </div>

    <!-- Menú Inferior -->
    <div class="bottom-nav">
      <a href="#" class="nav-item active" data-section="summary">
        <i class="fas fa-home"></i>
        <span>Resumen</span>
      </a>
      <a href="#" class="nav-item" data-section="history">
        <i class="fas fa-history"></i>
        <span>Historial</span>
      </a>
      <a href="#" class="nav-item" data-section="payment">
        <i class="fas fa-hand-holding-usd"></i>
        <span>Pagar</span>
      </a>
      <a href="#" class="nav-item" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i>
        <span>Salir</span>
      </a>
    </div>
  </section>

  <!-- Modal de Confirmación -->
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <h3 class="modal-title" id="confirmModalTitle">Confirmar Pago</h3>
      <p id="confirmModalMessage">¿Está seguro que desea registrar este pago?</p>
      <div class="modal-footer">
        <button id="confirmPaymentBtn" class="btn btn-success">Confirmar</button>
        <button id="cancelPaymentBtn" class="btn btn-danger">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Información -->
  <div class="modal" id="infoModal">
    <div class="modal-content">
      <h3 class="modal-title" id="infoModalTitle">Información</h3>
      <p id="infoModalMessage"></p>
      <div class="modal-footer">
        <button id="closeInfoModalBtn" class="btn">Aceptar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      getDocs, 
      query, 
      where,
      doc,
      getDoc,
      updateDoc,
      arrayUnion,
      Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // Configuración de Firebase (usar la misma del código anterior)
    const firebaseConfig = {
      apiKey: "AIzaSyDLi-egzQlgbKW8XV_qIhU6313Gd8gocCg",
      authDomain: "inventario-35d6b.firebaseapp.com",
      databaseURL: "https://inventario-35d6b-default-rtdb.firebaseio.com",
      projectId: "inventario-35d6b",
      storageBucket: "inventario-35d6b.appspot.com",
      messagingSenderId: "266100399659",
      appId: "1:266100399659:web:92358d28cbd803c8a7d46e"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Variables globales
    let currentUser = null;
    let currentLoan = null;
    let paymentData = null;

    // Inicialización
    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      
      // Establecer fecha actual como predeterminada
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('paymentDate').value = today;
    });

    // Configurar event listeners
    function setupEventListeners() {
      // Formulario de login
      document.getElementById('loginForm').addEventListener('submit', handleLogin);
      
      // Formulario de pago
      document.getElementById('paymentForm').addEventListener('submit', preparePayment);
      document.getElementById('paymentTypeFull').addEventListener('change', updatePaymentForm);
      document.getElementById('paymentTypeCapital').addEventListener('change', updatePaymentForm);
      document.getElementById('paymentTypeInterest').addEventListener('change', updatePaymentForm);
      document.getElementById('applyLateFee').addEventListener('change', toggleLateFeeDetails);
      document.getElementById('lateFeeAmount').addEventListener('input', validatePayment);
      
      // Menú inferior
      document.querySelectorAll('.nav-item').forEach(item => {
        if (!item.id) { // Excluir el botón de logout
          item.addEventListener('click', (e) => {
            e.preventDefault();
            navigateToSection(item.dataset.section);
          });
        }
      });
      
      // Botón de logout
      document.getElementById('logoutBtn').addEventListener('click', logout);
      
      // Modal de confirmación
      document.getElementById('confirmPaymentBtn').addEventListener('click', confirmPayment);
      document.getElementById('cancelPaymentBtn').addEventListener('click', closeModal);
      
      // Modal de información
      document.getElementById('closeInfoModalBtn').addEventListener('click', closeModal);
    }

    // Manejar login
    async function handleLogin(e) {
      e.preventDefault();
      
      const username = document.getElementById('loginUsername').value.trim();
      const pin = document.getElementById('loginPin').value.trim();
      
      try {
        // Buscar usuario en la colección LoanUsers
        const q = query(collection(db, "LoanUsers"), where("username", "==", username), where("pin", "==", pin));
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
          showAlert('Credenciales incorrectas', 'danger');
          return;
        }
        
        // Obtener datos del usuario
        const userDoc = querySnapshot.docs[0];
        currentUser = {
          id: userDoc.id,
          ...userDoc.data()
        };
        
        // Obtener el préstamo del usuario (asumimos solo un préstamo por usuario)
        const loanId = currentUser.loanIds[0];
        const loanRef = doc(db, "Loans", loanId);
        const loanSnap = await getDoc(loanRef);
        
        if (!loanSnap.exists()) {
          showAlert('No se encontró información del préstamo', 'danger');
          return;
        }
        
        currentLoan = {
          id: loanSnap.id,
          ...loanSnap.data()
        };
        
        // Mostrar sección del cliente
        showClientSection();
        
        // Cargar datos del cliente y préstamo
        loadClientData();
        
      } catch (error) {
        console.error("Error al iniciar sesión: ", error);
        showAlert('Ocurrió un error al iniciar sesión', 'danger');
      }
    }

    // Mostrar sección del cliente
    function showClientSection() {
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('client-section').style.display = 'block';
      navigateToSection('summary');
    }

    // Cargar datos del cliente y préstamo
    function loadClientData() {
      // Mostrar información del cliente
      document.getElementById('clientName').textContent = currentLoan.client.name;
      document.getElementById('clientId').textContent = `ID: ${currentLoan.client.id}`;
      
      // Mostrar iniciales en el avatar
      const initials = currentLoan.client.name.split(' ').map(n => n[0]).join('').toUpperCase();
      document.getElementById('clientAvatar').textContent = initials;
      
      // Mostrar información del préstamo
      document.getElementById('loanOriginalAmount').textContent = `$${currentLoan.amount.toFixed(2)}`;
      document.getElementById('loanBalance').textContent = `$${currentLoan.balance.toFixed(2)}`;
      
      // Calcular pagos realizados y pendientes
      const paymentsMade = currentLoan.payments ? currentLoan.payments.length : 0;
      const totalPayments = currentLoan.paymentSchedule.length;
      
      document.getElementById('paymentsMade').textContent = paymentsMade;
      document.getElementById('paymentsPending').textContent = totalPayments - paymentsMade;
      
      // Mostrar próximo pago
      const nextPayment = currentLoan.paymentSchedule.find(p => p.status === 'pending');
      if (nextPayment) {
        document.getElementById('nextPaymentDate').textContent = new Date(nextPayment.dueDate).toLocaleDateString();
        document.getElementById('nextPaymentAmount').textContent = `$${nextPayment.amount.toFixed(2)}`;
        document.getElementById('paymentAmount').value = nextPayment.amount.toFixed(2);
      }
      
      // Cargar historial de pagos
      loadPaymentHistory();
      
      // Actualizar formulario de pago
      updatePaymentForm();
    }

    // Cargar historial de pagos
    function loadPaymentHistory() {
      const container = document.getElementById('paymentHistory');
      container.innerHTML = '';
      
      if (!currentLoan.payments || currentLoan.payments.length === 0) {
        container.innerHTML = '<p>No hay pagos registrados</p>';
        return;
      }
      
      // Ordenar pagos por fecha (más reciente primero)
      const sortedPayments = [...currentLoan.payments].sort((a, b) => b.date.toDate() - a.date.toDate());
      
      sortedPayments.forEach(payment => {
        const paymentDate = payment.date.toDate();
        const paymentItem = document.createElement('div');
        paymentItem.className = 'payment-item';
        
        let typeClass = '';
        let typeText = '';
        
        switch(payment.type) {
          case 'capital':
            typeClass = 'capital';
            typeText = 'Capital';
            break;
          case 'interest':
            typeClass = 'interest';
            typeText = 'Interés';
            break;
          default:
            typeClass = '';
            typeText = 'Completo';
        }
        
        if (payment.lateFee && payment.lateFee > 0) {
          typeText += ' + Mora';
        }
        
        paymentItem.innerHTML = `
          <div>
            <div class="payment-amount">$${payment.amount.toFixed(2)}</div>
            <div class="payment-date">${paymentDate.toLocaleDateString()} ${paymentDate.toLocaleTimeString()}</div>
          </div>
          <div>
            <span class="payment-type ${typeClass}">${typeText}</span>
          </div>
        `;
        
        container.appendChild(paymentItem);
      });
    }

    // Actualizar formulario de pago según tipo seleccionado
    function updatePaymentForm() {
      const paymentType = document.querySelector('input[name="paymentType"]:checked').value;
      const lateFeeContainer = document.getElementById('lateFeeContainer');
      
      if (paymentType === 'full') {
        lateFeeContainer.style.display = 'block';
        
        // Establecer monto predeterminado para pago completo
        const nextPayment = currentLoan.paymentSchedule.find(p => p.status === 'pending');
        if (nextPayment) {
          document.getElementById('paymentAmount').value = nextPayment.amount.toFixed(2);
        }
      } else {
        lateFeeContainer.style.display = 'none';
        document.getElementById('applyLateFee').checked = false;
        document.getElementById('lateFeeDetails').style.display = 'none';
        
        // Permitir cualquier monto para pagos parciales
        document.getElementById('paymentAmount').value = '';
      }
      
      validatePayment();
    }

    // Mostrar/ocultar detalles de mora
    function toggleLateFeeDetails() {
      const applyLateFee = document.getElementById('applyLateFee').checked;
      document.getElementById('lateFeeDetails').style.display = applyLateFee ? 'block' : 'none';
      validatePayment();
    }

    // Validar pago
    function validatePayment() {
      const paymentType = document.querySelector('input[name="paymentType"]:checked').value;
      const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || 0;
      const applyLateFee = document.getElementById('applyLateFee').checked;
      const lateFeeAmount = parseFloat(document.getElementById('lateFeeAmount').value) || 0;
      const totalPayment = paymentAmount + (applyLateFee ? lateFeeAmount : 0);
      
      const nextPayment = currentLoan.paymentSchedule.find(p => p.status === 'pending');
      
      // Mostrar alerta si el pago es menor al esperado (solo para pago completo)
      if (paymentType === 'full' && nextPayment && totalPayment < nextPayment.amount) {
        showAlert(`El monto ingresado es menor al pago esperado ($${nextPayment.amount.toFixed(2)}).`, 'warning');
      } else {
        hideAlert();
      }
    }

    // Preparar pago (validar antes de confirmar)
    function preparePayment(e) {
      e.preventDefault();
      
      const paymentType = document.querySelector('input[name="paymentType"]:checked').value;
      const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || 0;
      const paymentDate = document.getElementById('paymentDate').value;
      const applyLateFee = document.getElementById('applyLateFee').checked;
      const lateFeeAmount = parseFloat(document.getElementById('lateFeeAmount').value) || 0;
      const totalPayment = paymentAmount + (applyLateFee ? lateFeeAmount : 0);
      
      const nextPayment = currentLoan.paymentSchedule.find(p => p.status === 'pending');
      
      // Validar monto mínimo
      if (paymentAmount <= 0) {
        showAlert('El monto del pago debe ser mayor a cero', 'danger');
        return;
      }
      
      // Validar pago completo insuficiente
      if (paymentType === 'full' && nextPayment && totalPayment < nextPayment.amount) {
        showConfirmModal(
          'Pago incompleto',
          `El monto ingresado ($${totalPayment.toFixed(2)}) es menor al pago esperado ($${nextPayment.amount.toFixed(2)}). ¿Desea continuar?`,
          () => {
            // Si el usuario confirma, proceder con el pago
            paymentData = {
              type: paymentType,
              amount: paymentAmount,
              date: paymentDate,
              lateFee: applyLateFee ? lateFeeAmount : 0,
              total: totalPayment
            };
            
            processPayment();
          }
        );
      } else {
        // Si el pago es suficiente o es parcial, proceder directamente
        paymentData = {
          type: paymentType,
          amount: paymentAmount,
          date: paymentDate,
          lateFee: applyLateFee ? lateFeeAmount : 0,
          total: totalPayment
        };
        
        processPayment();
      }
    }

    // Procesar pago (registrar en Firebase)
    async function processPayment() {
      try {
        const loanRef = doc(db, "Loans", currentLoan.id);
        
        // Crear objeto de pago
        const payment = {
          type: paymentData.type,
          amount: paymentData.amount,
          date: Timestamp.fromDate(new Date(paymentData.date)),
          recordedBy: `Cliente: ${currentLoan.client.name}`,
          timestamp: Timestamp.fromDate(new Date())
        };
        
        if (paymentData.lateFee > 0) {
          payment.lateFee = paymentData.lateFee;
        }
        
        // Calcular cómo afecta el pago al capital y al interés
        let capitalPayment = 0;
        let interestPayment = 0;
        
        if (paymentData.type === 'full') {
          // Pago completo: primero se aplica al interés pendiente, luego al capital
          const interestDue = currentLoan.totalInterest - (currentLoan.payments || []).reduce((sum, p) => {
            if (p.type === 'full') {
              return sum + (p.amount - (p.amount * (currentLoan.interestRate / 100 / currentLoan.term)));
            } else if (p.type === 'interest') {
              return sum + p.amount;
            }
            return sum;
          }, 0);
          
          interestPayment = Math.min(paymentData.amount, interestDue);
          capitalPayment = paymentData.amount - interestPayment;
        } else if (paymentData.type === 'interest') {
          // Solo interés
          interestPayment = paymentData.amount;
        } else if (paymentData.type === 'capital') {
          // Solo capital
          capitalPayment = paymentData.amount;
        }
        
        // Aplicar mora si existe
        if (paymentData.lateFee > 0) {
          interestPayment += paymentData.lateFee;
        }
        
        // Actualizar saldos
        const newBalance = currentLoan.balance - paymentData.total;
        const newRemainingCapital = currentLoan.remainingCapital - capitalPayment;
        
        // Marcar el próximo pago como completado si es un pago completo
        let updatedPaymentSchedule = [...currentLoan.paymentSchedule];
        if (paymentData.type === 'full') {
          const nextPayment = currentLoan.paymentSchedule.find(p => p.status === 'pending');
          if (nextPayment) {
            const paymentIndex = updatedPaymentSchedule.findIndex(p => p.number === nextPayment.number);
            if (paymentIndex !== -1) {
              updatedPaymentSchedule[paymentIndex].status = 'paid';
            }
          }
        }
        
        // Actualizar el documento en Firebase
        await updateDoc(loanRef, {
          payments: arrayUnion(payment),
          balance: newBalance,
          remainingCapital: newRemainingCapital,
          paymentSchedule: updatedPaymentSchedule,
          status: newRemainingCapital <= 0 ? 'completed' : 'active'
        });
        
        // Mostrar mensaje de éxito
        showInfoModal(
          'Pago registrado',
          'Tu pago ha sido registrado exitosamente y será procesado en menos de 24 horas.'
        );
        
        // Actualizar datos locales
        currentLoan.payments = currentLoan.payments || [];
        currentLoan.payments.push(payment);
        currentLoan.balance = newBalance;
        currentLoan.remainingCapital = newRemainingCapital;
        currentLoan.paymentSchedule = updatedPaymentSchedule;
        
        // Recargar datos
        loadClientData();
        
        // Limpiar formulario
        document.getElementById('paymentForm').reset();
        document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('lateFeeDetails').style.display = 'none';
        document.getElementById('applyLateFee').checked = false;
        
      } catch (error) {
        console.error("Error registrando pago: ", error);
        showAlert('Ocurrió un error al registrar el pago', 'danger');
      }
    }

    // Navegar entre secciones
    function navigateToSection(section) {
      // Actualizar menú
      document.querySelectorAll('.nav-item').forEach(item => {
        if (item.dataset.section === section) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
      
      // Aquí podrías implementar lógica para mostrar/ocultar secciones si es necesario
      // En este diseño, todo está en la misma página con scroll
      document.getElementById(section === 'payment' ? 'paymentForm' : section).scrollIntoView({
        behavior: 'smooth'
      });
    }

    // Mostrar alerta
    function showAlert(message, type) {
      const alert = document.getElementById('paymentAlert');
      alert.style.display = 'flex';
      alert.className = `alert alert-${type}`;
      document.getElementById('paymentAlertMessage').textContent = message;
    }

    // Ocultar alerta
    function hideAlert() {
      document.getElementById('paymentAlert').style.display = 'none';
    }

    // Mostrar modal de confirmación
    function showConfirmModal(title, message, onConfirm) {
      document.getElementById('confirmModalTitle').textContent = title;
      document.getElementById('confirmModalMessage').textContent = message;
      document.getElementById('confirmModal').classList.add('active');
      
      // Configurar acción de confirmación
      const confirmBtn = document.getElementById('confirmPaymentBtn');
      const handler = () => {
        confirmBtn.removeEventListener('click', handler);
        closeModal();
        onConfirm();
      };
      
      confirmBtn.addEventListener('click', handler);
    }

    // Mostrar modal de información
    function showInfoModal(title, message) {
      document.getElementById('infoModalTitle').textContent = title;
      document.getElementById('infoModalMessage').textContent = message;
      document.getElementById('infoModal').classList.add('active');
    }

    // Cerrar modal
    function closeModal() {
      document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.remove('active');
      });
    }

    // Cerrar sesión
    function logout() {
      currentUser = null;
      currentLoan = null;
      
      document.getElementById('login-section').style.display = 'flex';
      document.getElementById('client-section').style.display = 'none';
      
      // Limpiar formulario de login
      document.getElementById('loginForm').reset();
    }
  </script>
</body>
</html>
